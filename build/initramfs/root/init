#!/bin/sh
set -eu

log() { printf "[INIT] %s\n" "$1"; }

mount -t devtmpfs devtmpfs /dev
mount -t proc proc /proc
mount -t sysfs sys /sys
mount -t tmpfs tmpfs /run

# Ensure console
[ -c /dev/console ] || mknod -m 600 /dev/console c 5 1
exec 0</dev/console 1>/dev/console 2>/dev/console

log "booting volant init"

STAGING_SCRIPT=/scripts/stage-volary.sh
ROOTFS_IMAGE="${VOLANT_ROOTFS:-}"

if [ -n "$ROOTFS_IMAGE" ]; then
    log "fetching rootfs $ROOTFS_IMAGE"
    mkdir -p /sysroot
    if sh /scripts/fetch-rootfs.sh "$ROOTFS_IMAGE" /root/rootfs.img; then
        mount -o loop /root/rootfs.img /sysroot || log "loop mount failed"
    fi
    if mountpoint -q /sysroot; then
        log "staging volary into rootfs"
        [ -x "$STAGING_SCRIPT" ] && "$STAGING_SCRIPT" /sysroot || log "stage-volary missing"
        if [ -x /sysroot/usr/local/bin/volary ]; then
            log "switching root"
            cd /sysroot
            umount /proc /sys /dev 2>/dev/null || true
            exec switch_root /sysroot /usr/local/bin/volary
        fi
        log "volary missing after staging; rescue shell"
        exec sh
    fi
    log "rootfs not mounted; continuing with initrd"
fi

# Fallback: run volary directly from initramfs
if [ -x /usr/local/bin/volary ]; then
    log "launching volary directly"
    exec /usr/local/bin/volary
fi

log "volary missing; dropping to shell"
exec sh
